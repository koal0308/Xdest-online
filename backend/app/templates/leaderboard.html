{% extends "base.html" %}

{% block title %}Leaderboard - Xdest{% endblock %}

{% block content %}
<div class="min-h-screen">
    {% set active_page = 'leaderboard' %}
    {% include 'partials/nav.html' %}

    <main class="pt-24 pb-12 px-4 max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold mb-4">Leaderboard</h1>
            <p class="text-gray-400 text-lg" id="header-subtitle">The most helpful members</p>
            <p class="text-sm text-gray-500 mt-2" id="header-desc">Every positive action = <span class="text-green-400 font-semibold">+1</span> Â· Every negative action = <span class="text-red-400 font-semibold">-1</span></p>
        </div>

        <!-- Tab Switcher -->
        <div class="flex justify-center mb-8">
            <div class="inline-flex bg-dark-100 rounded-xl border border-gray-800 p-1">
                <button id="tab-score" onclick="switchTab('score')" 
                        class="px-6 py-2.5 rounded-lg text-sm font-semibold transition-all bg-purple-500 text-white">
                    ğŸ† Score
                </button>
                <button id="tab-karma" onclick="switchTab('karma')" 
                        class="px-6 py-2.5 rounded-lg text-sm font-semibold transition-all text-gray-400 hover:text-white">
                    ğŸ§ª Karma
                </button>
            </div>
        </div>

        <!-- Top 3 Podium -->
        <div class="flex justify-center items-end gap-4 mb-12" id="podium">
            <!-- Filled by JavaScript -->
        </div>

        {% if user %}
        <!-- Personal Stats Section - Score View -->
        <div class="bg-dark-100 rounded-xl border border-gray-800 p-6 mb-8" id="my-stats-score">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span>ğŸ‘¤</span> Your Score
                </h2>
                <div id="my-rank-score" class="text-lg font-bold text-gray-400">Loading...</div>
            </div>
            
            <!-- Score Breakdown -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-2xl mb-1">âœ…</div>
                    <div class="text-xs text-gray-400">Solutions</div>
                    <div class="font-bold text-green-400" id="stat-solutions">-</div>
                </div>
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-2xl mb-1">ğŸ‘</div>
                    <div class="text-xs text-gray-400">Response Votes</div>
                    <div class="font-bold text-blue-400" id="stat-response-helpful">-</div>
                </div>
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-2xl mb-1">ğŸ“</div>
                    <div class="text-xs text-gray-400">Issue Votes</div>
                    <div class="font-bold text-yellow-400" id="stat-issue-helpful">-</div>
                </div>
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-2xl mb-1">ğŸ™</div>
                    <div class="text-xs text-gray-400">GitHub</div>
                    <div class="font-bold text-purple-400" id="stat-github">-</div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-2xl mb-1">â­</div>
                    <div class="text-xs text-gray-400">5-Star Ratings</div>
                    <div class="font-bold text-yellow-400" id="stat-five-star">-</div>
                </div>
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-2xl mb-1">ğŸ§ª</div>
                    <div class="text-xs text-gray-400">Issues Given</div>
                    <div class="font-bold text-cyan-400" id="stat-issues-given">-</div>
                </div>
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-2xl mb-1">ğŸ“¥</div>
                    <div class="text-xs text-gray-400">Issues Received</div>
                    <div class="font-bold text-teal-400" id="stat-issues-received">-</div>
                </div>
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-2xl mb-1">âš ï¸</div>
                    <div class="text-xs text-gray-400">Overdue Offers</div>
                    <div class="font-bold text-red-400" id="stat-offer-penalties">-</div>
                </div>
            </div>
            
            <!-- Total Score -->
            <div class="flex items-center justify-between bg-dark-200 rounded-lg p-4 mb-4 border border-purple-500/30">
                <span class="text-gray-400">Total Score</span>
                <span class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent" id="my-total-score">-</span>
            </div>

            <!-- Activity Overview -->
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-xs text-gray-500">Responses</div>
                    <div class="font-bold" id="stat-total-responses">0</div>
                </div>
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-xs text-gray-500">Issues</div>
                    <div class="font-bold" id="stat-total-issues">0</div>
                </div>
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-xs text-gray-500">Projects</div>
                    <div class="font-bold" id="stat-projects-count">0</div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div>
                <h3 class="text-sm font-semibold text-gray-400 mb-3">Recent Activity</h3>
                <div id="recent-activities" class="space-y-2">
                    <div class="text-center text-gray-500 text-sm py-2">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Personal Stats Section - Karma View -->
        <div class="bg-dark-100 rounded-xl border border-gray-800 p-6 mb-8 hidden" id="my-stats-karma">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span>ğŸ§ª</span> Your Karma
                </h2>
                <div id="my-rank-karma" class="text-lg font-bold text-gray-400">-</div>
            </div>

            <!-- Karma Breakdown -->
            <div class="grid grid-cols-3 gap-3 mb-6">
                <div class="bg-dark-200 rounded-lg p-4 text-center border border-gray-800">
                    <div class="text-3xl mb-2">ğŸ§ª</div>
                    <div class="text-xs text-gray-400 mb-1">Issues Given</div>
                    <div class="text-2xl font-bold text-cyan-400" id="karma-given">0</div>
                    <div class="text-xs text-gray-500 mt-1">To other projects</div>
                </div>
                <div class="bg-dark-200 rounded-lg p-4 text-center border border-gray-800">
                    <div class="text-3xl mb-2">ğŸ“¥</div>
                    <div class="text-xs text-gray-400 mb-1">Issues Received</div>
                    <div class="text-2xl font-bold text-teal-400" id="karma-received">0</div>
                    <div class="text-xs text-gray-500 mt-1">On your projects</div>
                </div>
                <div class="bg-dark-200 rounded-lg p-4 text-center border border-gray-800">
                    <div class="text-3xl mb-2">âš ï¸</div>
                    <div class="text-xs text-gray-400 mb-1">Overdue Offers</div>
                    <div class="text-2xl font-bold text-red-400" id="karma-penalties">0</div>
                    <div class="text-xs text-gray-500 mt-1">Unfulfilled offers</div>
                </div>
            </div>

            <!-- Karma Bar -->
            <div class="bg-dark-200 rounded-lg p-4 mb-4 border border-gray-800">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-400 text-sm">Test Karma</span>
                    <span class="font-bold text-lg" id="karma-total-value">0</span>
                </div>
                <div class="h-3 bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full rounded-full transition-all" id="karma-total-progress" style="width: 50%; background: linear-gradient(to right, #06b6d4, #8b5cf6);"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-600 mt-1">
                    <span>Receiver</span>
                    <span>Balanced</span>
                    <span>Tester</span>
                </div>
            </div>

            <!-- Karma Explanation -->
            <div class="bg-dark-200/50 rounded-lg p-4 border border-gray-800">
                <p class="text-sm text-gray-400">
                    <span class="text-cyan-400 font-semibold">Karma = Issues Given âˆ’ Issues Received âˆ’ Overdue Offers</span><br>
                    <span class="text-gray-500 mt-1 block">Positive karma = you test more than you receive. Stay balanced or give back to the community!</span>
                </p>
            </div>
        </div>
        {% endif %}

        <!-- Full Leaderboard -->
        <div class="bg-dark-100 rounded-xl border border-gray-800 overflow-hidden">
            <div class="p-4 border-b border-gray-800 bg-dark-200 flex items-center justify-between">
                <h2 class="font-semibold" id="ranking-title">Complete Ranking</h2>
                <span class="text-xs text-gray-500" id="leaderboard-count"></span>
            </div>
            
            <div id="leaderboard-list">
                <div class="p-8 text-center text-gray-500" id="loading">
                    <div class="animate-spin w-8 h-8 border-2 border-purple-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                    Loading leaderboard...
                </div>
            </div>
        </div>

        <!-- Info Box - Score -->
        <div class="mt-8 bg-dark-100 rounded-xl border border-gray-800 p-6" id="info-score">
            <h3 class="font-semibold mb-4 flex items-center gap-2">
                <span class="text-xl">ğŸ’¡</span> How does scoring work?
            </h3>
            <p class="text-sm text-gray-500 mb-4">Every action is worth exactly <span class="text-green-400 font-bold">+1</span> or <span class="text-red-400 font-bold">-1</span> â€” simple and fair. No inflated numbers.</p>
            
            <div class="grid md:grid-cols-2 gap-4 text-gray-400 text-sm">
                <div class="flex items-start gap-3">
                    <span class="text-green-400 text-lg">âœ…</span>
                    <div>
                        <p class="font-medium text-white">Solution marked <span class="text-green-400">(+1)</span></p>
                        <p>When the issue creator marks your answer as the solution</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-blue-400 text-lg">ğŸ‘</span>
                    <div>
                        <p class="font-medium text-white">Helpful vote <span class="text-green-400">(+1)</span></p>
                        <p>When other users mark your answer or issue as helpful</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-purple-400 text-lg">ğŸ™</span>
                    <div>
                        <p class="font-medium text-white">GitHub ğŸ‘ <span class="text-green-400">(+1)</span> / ğŸ‘ <span class="text-red-400">(-1)</span></p>
                        <p>GitHub reactions on your issues</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-yellow-400 text-lg">â­</span>
                    <div>
                        <p class="font-medium text-white">5-Star rating <span class="text-green-400">(+1)</span></p>
                        <p>When other users rate you with 5 stars</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-cyan-400 text-lg">ğŸ§ª</span>
                    <div>
                        <p class="font-medium text-white">Issues given / received <span class="text-green-400">(+1 each)</span></p>
                        <p>Testing other projects & receiving tests</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-red-400 text-lg">âš ï¸</span>
                    <div>
                        <p class="font-medium text-white">Overdue offers <span class="text-red-400">(-1)</span></p>
                        <p>Unfulfilled offer obligations</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Box - Karma -->
        <div class="mt-8 bg-dark-100 rounded-xl border border-gray-800 p-6 hidden" id="info-karma">
            <h3 class="font-semibold mb-4 flex items-center gap-2">
                <span class="text-xl">ğŸ§ª</span> How does Test Karma work?
            </h3>
            <p class="text-sm text-gray-500 mb-4">Karma measures the balance between testing others and receiving tests.</p>
            
            <div class="grid md:grid-cols-2 gap-4 text-gray-400 text-sm">
                <div class="flex items-start gap-3">
                    <span class="text-cyan-400 text-lg">ğŸ§ª</span>
                    <div>
                        <p class="font-medium text-white">Issues Given <span class="text-cyan-400">(+1 karma)</span></p>
                        <p>Each issue you write for someone else's project gives you +1 karma</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-teal-400 text-lg">ğŸ“¥</span>
                    <div>
                        <p class="font-medium text-white">Issues Received <span class="text-red-400">(-1 karma)</span></p>
                        <p>Each issue someone writes on your project costs -1 karma</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-red-400 text-lg">âš ï¸</span>
                    <div>
                        <p class="font-medium text-white">Overdue Offers <span class="text-red-400">(-1 karma)</span></p>
                        <p>Not fulfilling an offer obligation within 7 days</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-green-400 text-lg">âš–ï¸</span>
                    <div>
                        <p class="font-medium text-white">Stay Balanced</p>
                        <p>Give back to the community â€” test others' projects to keep your karma positive!</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Footer -->
<footer class="border-t border-gray-800 bg-gray-950 py-4 px-6 mt-8">
    <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-2 text-xs text-gray-500">
        <span>Â© 2026 Xdest</span>
        <div class="flex flex-wrap justify-center gap-4">
            <a href="mailto:aiandfriends@gmail.com" class="hover:text-gray-300 transition">Contact</a>
            <a href="https://x.com/karlbeis" target="_blank" class="hover:text-gray-300 transition">ğ• @karlbeis</a>
            <a href="/privacy" class="hover:text-gray-300 transition">Privacy</a>
            <a href="/terms" class="hover:text-gray-300 transition">Terms</a>
            <a href="https://github.com/koal0308/Xdest" target="_blank" class="hover:text-gray-300 transition">GitHub</a>
        </div>
    </div>
</footer>

<script>
let leaderboardData = [];
let currentTab = 'score';

function switchTab(tab) {
    currentTab = tab;
    
    // Update tab buttons
    const scoreBtn = document.getElementById('tab-score');
    const karmaBtn = document.getElementById('tab-karma');
    
    if (tab === 'score') {
        scoreBtn.className = 'px-6 py-2.5 rounded-lg text-sm font-semibold transition-all bg-purple-500 text-white';
        karmaBtn.className = 'px-6 py-2.5 rounded-lg text-sm font-semibold transition-all text-gray-400 hover:text-white';
    } else {
        karmaBtn.className = 'px-6 py-2.5 rounded-lg text-sm font-semibold transition-all bg-cyan-500 text-white';
        scoreBtn.className = 'px-6 py-2.5 rounded-lg text-sm font-semibold transition-all text-gray-400 hover:text-white';
    }

    // Update header
    document.getElementById('header-subtitle').textContent = tab === 'score' 
        ? 'The most helpful members' 
        : 'Who tests the most?';
    document.getElementById('header-desc').innerHTML = tab === 'score'
        ? 'Every positive action = <span class="text-green-400 font-semibold">+1</span> Â· Every negative action = <span class="text-red-400 font-semibold">-1</span>'
        : 'Karma = <span class="text-cyan-400 font-semibold">Issues Given</span> âˆ’ <span class="text-teal-400 font-semibold">Issues Received</span> âˆ’ <span class="text-red-400 font-semibold">Overdue Offers</span>';

    // Update ranking title
    document.getElementById('ranking-title').textContent = tab === 'score' 
        ? 'Score Ranking' : 'Karma Ranking';

    // Toggle personal stats panels
    const scoreStats = document.getElementById('my-stats-score');
    const karmaStats = document.getElementById('my-stats-karma');
    if (scoreStats && karmaStats) {
        if (tab === 'score') {
            scoreStats.classList.remove('hidden');
            karmaStats.classList.add('hidden');
        } else {
            scoreStats.classList.add('hidden');
            karmaStats.classList.remove('hidden');
        }
    }

    // Toggle info boxes
    document.getElementById('info-score').classList.toggle('hidden', tab !== 'score');
    document.getElementById('info-karma').classList.toggle('hidden', tab !== 'karma');
    
    renderLeaderboard(leaderboardData, tab);
}

function renderLeaderboard(data, tab) {
    const podiumEl = document.getElementById('podium');
    const listEl = document.getElementById('leaderboard-list');
    const countEl = document.getElementById('leaderboard-count');
    
    // Sort by selected metric
    let sorted;
    if (tab === 'score') {
        sorted = [...data].sort((a, b) => b.total_score - a.total_score);
        sorted = sorted.filter(u => u.total_score > 0);
    } else {
        // Karma: issues_given - issues_received - offer_penalties
        sorted = [...data].map(u => ({...u}));
        sorted.forEach(u => { u._karma = (u.issues_given || 0) - (u.issues_received || 0) - (u.offer_penalties || 0); });
        sorted.sort((a, b) => b._karma - a._karma || b.issues_given - a.issues_given);
        // Only show users with positive karma (hide zero and negative)
        sorted = sorted.filter(u => u._karma > 0);
    }
    
    // Re-rank
    sorted.forEach((u, i) => { u._rank = i + 1; });
    
    if (sorted.length === 0) {
        const emptyMsg = tab === 'score' 
            ? 'No one on the board yet' 
            : 'No karma activity yet';
        const emptyHint = tab === 'score'
            ? 'Be the first to help others!'
            : 'Test other projects to earn karma!';
        listEl.innerHTML = `
            <div class="p-12 text-center text-gray-500">
                <div class="text-5xl mb-4">${tab === 'score' ? 'ğŸ¤·' : 'ğŸ§ª'}</div>
                <p class="text-lg">${emptyMsg}</p>
                <p class="text-sm mt-2">${emptyHint}</p>
            </div>
        `;
        podiumEl.innerHTML = '';
        countEl.textContent = '';
        return;
    }
    
    countEl.textContent = sorted.length + ' members';
    
    // Podium
    const top3 = sorted.slice(0, 3);
    const podiumOrder = [1, 0, 2];
    const podiumColors = ['from-yellow-500 to-yellow-600', 'from-gray-400 to-gray-500', 'from-orange-600 to-orange-700'];
    const podiumHeights = ['h-32', 'h-24', 'h-20'];
    const podiumLabels = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
    
    const scoreGradient = 'from-purple-400 to-pink-500';
    const karmaGradient = 'from-cyan-400 to-teal-500';
    const activeGradient = tab === 'score' ? scoreGradient : karmaGradient;
    
    podiumEl.innerHTML = podiumOrder.map((idx) => {
        if (!top3[idx]) return '';
        const u = top3[idx];
        const height = podiumHeights[idx];
        const color = podiumColors[idx];
        const label = podiumLabels[idx];
        const displayValue = tab === 'score' ? u.total_score : (u._karma >= 0 ? '+' + u._karma : u._karma);
        
        return `
            <a href="/user/${u.username}" class="flex flex-col items-center group">
                <img src="${u.avatar || '/static/default-avatar.png'}" 
                     class="w-16 h-16 rounded-full border-4 border-gray-700 group-hover:border-purple-500 transition mb-2" 
                     alt="${u.username}">
                <span class="font-semibold group-hover:text-purple-400 transition">${u.username}</span>
                <span class="text-2xl">${label}</span>
                <span class="text-sm font-bold bg-gradient-to-r ${activeGradient} bg-clip-text text-transparent">${displayValue}</span>
                ${tab === 'karma' ? `<span class="text-xs text-gray-400">ğŸ§ª ${u.issues_given} given Â· ğŸ“¥ ${u.issues_received} received</span>` : ''}
                <div class="${height} w-20 bg-gradient-to-t ${color} rounded-t-lg mt-2 flex items-center justify-center">
                    <span class="text-white font-bold text-2xl">${idx + 1}</span>
                </div>
            </a>
        `;
    }).join('');
    
    // Full List
    if (tab === 'score') {
        listEl.innerHTML = sorted.map(u => {
            let chips = [];
            if (u.solutions > 0) chips.push(`âœ… ${u.solutions}`);
            if (u.response_helpful > 0) chips.push(`ğŸ‘ ${u.response_helpful}`);
            if (u.issue_helpful > 0) chips.push(`ğŸ“ ${u.issue_helpful}`);
            if (u.github_positive > 0) chips.push(`ğŸ™ +${u.github_positive}`);
            if (u.github_negative > 0) chips.push(`ğŸ‘ -${u.github_negative}`);
            if (u.five_star_ratings > 0) chips.push(`â­ ${u.five_star_ratings}`);
            if (u.issues_given > 0) chips.push(`ğŸ§ª ${u.issues_given}`);
            if (u.issues_received > 0) chips.push(`ğŸ“¥ ${u.issues_received}`);
            if (u.offer_penalties > 0) chips.push(`âš ï¸ -${u.offer_penalties}`);
            
            return `
                <a href="/user/${u.username}" 
                   class="flex items-center gap-4 p-4 hover:bg-dark-200 transition border-b border-gray-800 last:border-0">
                    <div class="w-8 text-center font-bold ${u._rank <= 3 ? 'text-yellow-400' : 'text-gray-500'}">
                        ${u._rank <= 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][u._rank - 1] : '#' + u._rank}
                    </div>
                    <img src="${u.avatar || '/static/default-avatar.png'}" 
                         class="w-10 h-10 rounded-full" alt="">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 flex-wrap">
                            <p class="font-semibold">${u.username}</p>
                        </div>
                        <p class="text-sm text-gray-500 truncate">${chips.join(' Â· ')}</p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="font-bold text-lg bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent">
                            ${u.total_score}
                        </p>
                        <p class="text-xs text-gray-500">Score</p>
                    </div>
                </a>
            `;
        }).join('');
    } else {
        // Karma tab
        listEl.innerHTML = sorted.map(u => {
            const karma = u._karma;
            const karmaColor = karma > 0 ? 'text-cyan-400' : karma < 0 ? 'text-red-400' : 'text-gray-400';
            const karmaBarWidth = Math.max(5, Math.min(95, 50 + (karma * 8)));
            const karmaBarColor = karma >= 0 
                ? 'background: linear-gradient(to right, #06b6d4, #8b5cf6)' 
                : 'background: linear-gradient(to right, #ef4444, #f97316)';
            
            return `
                <a href="/user/${u.username}" 
                   class="flex items-center gap-4 p-4 hover:bg-dark-200 transition border-b border-gray-800 last:border-0">
                    <div class="w-8 text-center font-bold ${u._rank <= 3 ? 'text-cyan-400' : 'text-gray-500'}">
                        ${u._rank <= 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][u._rank - 1] : '#' + u._rank}
                    </div>
                    <img src="${u.avatar || '/static/default-avatar.png'}" 
                         class="w-10 h-10 rounded-full" alt="">
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold mb-1">${u.username}</p>
                        <div class="flex items-center gap-3 text-xs text-gray-500">
                            <span>ğŸ§ª ${u.issues_given} given</span>
                            <span>ğŸ“¥ ${u.issues_received} received</span>
                        </div>
                        <div class="mt-1.5 h-1.5 bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full rounded-full transition-all" style="width: ${karmaBarWidth}%; ${karmaBarColor}"></div>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="font-bold text-lg ${karmaColor}">
                            ${karma >= 0 ? '+' : ''}${karma}
                        </p>
                        <p class="text-xs text-gray-500">Karma</p>
                    </div>
                </a>
            `;
        }).join('');
    }
}

{% if user %}
async function loadMyStats() {
    try {
        const response = await fetch('/api/leaderboard/my-stats', {
            credentials: 'include'
        });
        if (!response.ok) {
            console.log('My stats response not ok:', response.status);
            return;
        }
        
        const data = await response.json();
        const b = data.breakdown;
        
        // === SCORE PANEL ===
        // Score Rank
        const rankScoreEl = document.getElementById('my-rank-score');
        if (data.rank) {
            const rankEmoji = data.rank === 1 ? 'ğŸ¥‡' : data.rank === 2 ? 'ğŸ¥ˆ' : data.rank === 3 ? 'ğŸ¥‰' : '#';
            rankScoreEl.innerHTML = `Rank: ${rankEmoji}${data.rank <= 3 ? '' : data.rank}`;
        } else {
            rankScoreEl.innerHTML = '<span class="text-gray-500 text-sm">Not ranked yet</span>';
        }
        
        // Score Breakdown
        document.getElementById('stat-solutions').textContent = 
            `${b.solutions.count} (${b.solutions.points > 0 ? '+' : ''}${b.solutions.points})`;
        document.getElementById('stat-response-helpful').textContent = 
            `${b.response_helpful.count} (${b.response_helpful.points > 0 ? '+' : ''}${b.response_helpful.points})`;
        document.getElementById('stat-issue-helpful').textContent = 
            `${b.issue_helpful.count} (${b.issue_helpful.points > 0 ? '+' : ''}${b.issue_helpful.points})`;
        
        const ghPoints = b.github_reactions.points;
        document.getElementById('stat-github').textContent = 
            `+${b.github_reactions.positive}/-${b.github_reactions.negative} (${ghPoints >= 0 ? '+' : ''}${ghPoints})`;
        
        document.getElementById('stat-five-star').textContent = 
            `${b.five_star_ratings.count} (+${b.five_star_ratings.points})`;
        document.getElementById('stat-issues-given').textContent = 
            `${b.issues_given.count} (+${b.issues_given.points})`;
        document.getElementById('stat-issues-received').textContent = 
            `${b.issues_received.count} (+${b.issues_received.points})`;
        document.getElementById('stat-offer-penalties').textContent = 
            b.offer_penalties.count > 0 ? `${b.offer_penalties.count} (${b.offer_penalties.points})` : '0';
        
        // Total Score
        document.getElementById('my-total-score').textContent = data.total_score;

        // Activity overview
        if (data.stats) {
            document.getElementById('stat-total-responses').textContent = data.stats.total_responses || 0;
            document.getElementById('stat-total-issues').textContent = data.stats.total_issues || 0;
            document.getElementById('stat-projects-count').textContent = data.stats.projects_count || 0;
        }
        
        // Recent Activities
        const activitiesEl = document.getElementById('recent-activities');
        if (data.recent_activities.length === 0) {
            activitiesEl.innerHTML = `
                <div class="text-center text-gray-500 text-sm py-4">
                    <p>No activity yet</p>
                    <p class="mt-1">Report issues, give helpful answers!</p>
                </div>
            `;
        } else {
            activitiesEl.innerHTML = data.recent_activities.map(activity => {
                const typeIcons = {
                    'solution': 'âœ…',
                    'response_helpful': 'ğŸ‘',
                    'issue_helpful': 'ğŸ“',
                    'five_star': 'â­',
                    'karma_given': 'ğŸ§ª',
                    'karma_received': 'ğŸ“¥',
                    'offer_penalty': 'âš ï¸'
                };
                const typeColors = {
                    'solution': 'text-green-400',
                    'response_helpful': 'text-blue-400',
                    'issue_helpful': 'text-yellow-400',
                    'five_star': 'text-yellow-400',
                    'karma_given': 'text-cyan-400',
                    'karma_received': 'text-teal-400',
                    'offer_penalty': 'text-red-400'
                };
                
                const date = activity.created_at ? new Date(activity.created_at).toLocaleDateString() : '';
                const pointsDisplay = activity.points >= 0 ? `+${activity.points}` : `${activity.points}`;
                const pointColor = activity.points >= 0 ? (typeColors[activity.type] || 'text-purple-400') : 'text-red-400';
                
                return `
                    <div class="flex items-center gap-3 bg-dark-200/50 rounded-lg p-3 text-sm">
                        <span class="text-xl">${typeIcons[activity.type] || 'ğŸ¯'}</span>
                        <div class="flex-1 min-w-0">
                            <p class="truncate">${activity.description}</p>
                            ${activity.project ? `<p class="text-xs text-gray-500">${activity.project}</p>` : ''}
                        </div>
                        <div class="text-right flex-shrink-0">
                            <span class="${pointColor} font-bold">${pointsDisplay}</span>
                            <p class="text-xs text-gray-500">${date}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // === KARMA PANEL ===
        // Karma values
        const karmaVal = data.test_karma || 0;
        document.getElementById('karma-given').textContent = b.issues_given.count;
        document.getElementById('karma-received').textContent = b.issues_received.count;
        document.getElementById('karma-penalties').textContent = b.offer_penalties.count;
        
        // Karma total
        const karmaTotalEl = document.getElementById('karma-total-value');
        karmaTotalEl.textContent = (karmaVal >= 0 ? '+' : '') + karmaVal;
        karmaTotalEl.className = karmaVal >= 0 ? 'font-bold text-lg text-cyan-400' : 'font-bold text-lg text-red-400';
        
        // Karma progress bar (center = 50%, range -10 to +10)
        const karmaProgress = document.getElementById('karma-total-progress');
        const karmaPercent = Math.max(5, Math.min(95, 50 + (karmaVal * 5)));
        karmaProgress.style.width = karmaPercent + '%';
        karmaProgress.style.background = karmaVal >= 0 
            ? 'linear-gradient(to right, #06b6d4, #8b5cf6)' 
            : 'linear-gradient(to right, #ef4444, #f97316)';
        
        // Karma Rank - calculate from leaderboard data
        const rankKarmaEl = document.getElementById('my-rank-karma');
        if (leaderboardData && leaderboardData.length > 0) {
            const karmaSorted = [...leaderboardData].sort((a, b) => b.test_karma - a.test_karma);
            const myKarmaRank = karmaSorted.findIndex(u => u.user_id === data.user_id) + 1;
            if (myKarmaRank > 0) {
                const kRankEmoji = myKarmaRank === 1 ? 'ğŸ¥‡' : myKarmaRank === 2 ? 'ğŸ¥ˆ' : myKarmaRank === 3 ? 'ğŸ¥‰' : '#';
                rankKarmaEl.innerHTML = `Rank: ${kRankEmoji}${myKarmaRank <= 3 ? '' : myKarmaRank}`;
            } else {
                rankKarmaEl.innerHTML = '<span class="text-gray-500 text-sm">Not ranked yet</span>';
            }
        } else {
            rankKarmaEl.innerHTML = '<span class="text-gray-500 text-sm">Not ranked yet</span>';
        }
        
    } catch (error) {
        console.error('Error loading my stats:', error);
    }
}
{% endif %}

document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/api/leaderboard');
        const data = await response.json();
        leaderboardData = data.leaderboard;
        renderLeaderboard(leaderboardData, 'score');
    } catch (error) {
        console.error('Error loading leaderboard:', error);
        document.getElementById('leaderboard-list').innerHTML = `
            <div class="p-8 text-center text-red-400">
                Error loading leaderboard
            </div>
        `;
    }
    
    {% if user %}
    loadMyStats();
    {% endif %}
});
</script>
{% endblock %}
