{% extends "base.html" %}

{% block title %}Leaderboard - Xdest{% endblock %}

{% block content %}
<div class="min-h-screen">
    {% set active_page = 'leaderboard' %}
    {% include 'partials/nav.html' %}

    <main class="pt-24 pb-12 px-4 max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold mb-4">Leaderboard</h1>
            <p class="text-gray-400 text-lg">The most helpful members</p>
            <p class="text-sm text-gray-500 mt-2">Points: Solution marked = 10 points | Helpful vote = 1 point</p>
        </div>

        <!-- Top 3 Podium -->
        <div class="flex justify-center items-end gap-4 mb-12" id="podium">
            <!-- Wird per JavaScript gefÃ¼llt -->
        </div>

        {% if user %}
        <!-- Personal Stats Section -->
        <div class="bg-dark-100 rounded-xl border border-gray-800 p-6 mb-8" id="my-stats-section">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span>ğŸ‘¤</span> Your Stats
                </h2>
                <div id="my-rank" class="text-lg font-bold text-gray-400">Loading...</div>
            </div>
            
            <!-- Points Breakdown -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6" id="my-breakdown">
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-2xl mb-1">âœ…</div>
                    <div class="text-xs text-gray-400">Solutions</div>
                    <div class="font-bold text-green-400" id="stat-solutions">-</div>
                </div>
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-2xl mb-1">ğŸ‘</div>
                    <div class="text-xs text-gray-400">Response Votes</div>
                    <div class="font-bold text-blue-400" id="stat-response-helpful">-</div>
                </div>
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-2xl mb-1">ğŸ“</div>
                    <div class="text-xs text-gray-400">Issue Votes</div>
                    <div class="font-bold text-yellow-400" id="stat-issue-helpful">-</div>
                </div>
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-2xl mb-1">ğŸ™</div>
                    <div class="text-xs text-gray-400">GitHub</div>
                    <div class="font-bold text-purple-400" id="stat-github">-</div>
                </div>
                <div class="bg-dark-200 rounded-lg p-3 text-center border border-gray-800">
                    <div class="text-2xl mb-1">â­</div>
                    <div class="text-xs text-gray-400">5-Star Ratings</div>
                    <div class="font-bold text-yellow-400" id="stat-five-star">-</div>
                </div>
            </div>
            
            <!-- Total Score -->
            <div class="flex items-center justify-between bg-dark-200 rounded-lg p-4 mb-4 border border-gray-800">
                <span class="text-gray-400">Total Score</span>
                <span class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent" id="my-total-score">-</span>
            </div>
            
            <!-- Recent Activity -->
            <div>
                <h3 class="text-sm font-semibold text-gray-400 mb-3">Recent Point Activity</h3>
                <div id="recent-activities" class="space-y-2">
                    <div class="text-center text-gray-500 text-sm py-2">Loading...</div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Full Leaderboard -->
        <div class="bg-dark-100 rounded-xl border border-gray-800 overflow-hidden">
            <div class="p-4 border-b border-gray-800 bg-dark-200">
                <h2 class="font-semibold">Complete Ranking</h2>
            </div>
            
            <div id="leaderboard-list">
                <!-- Loading State -->
                <div class="p-8 text-center text-gray-500" id="loading">
                    <div class="animate-spin w-8 h-8 border-2 border-purple-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                    Loading leaderboard...
                </div>
            </div>
        </div>

        <!-- Info Box -->
        <div class="mt-8 bg-dark-100 rounded-xl border border-gray-800 p-6">
            <h3 class="font-semibold mb-3 flex items-center gap-2">
                <span class="text-xl">ğŸ’¡</span> How to earn points?
            </h3>
            <div class="grid md:grid-cols-2 gap-4 text-gray-400 text-sm">
                <div class="flex items-start gap-3">
                    <span class="text-green-400 text-lg">âœ…</span>
                    <div>
                        <p class="font-medium text-white">Solution marked (+10 points)</p>
                        <p>When the issue creator marks your answer as the solution</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-blue-400 text-lg">ğŸ‘</span>
                    <div>
                        <p class="font-medium text-white">Helpful vote (+1 point)</p>
                        <p>When other users mark your answer or issue as helpful</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-purple-400 text-lg">ğŸ™</span>
                    <div>
                        <p class="font-medium text-white">GitHub ğŸ‘ Reaction (+2 points)</p>
                        <p>When your issue gets a ğŸ‘ reaction on GitHub</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-red-400 text-lg">ğŸ‘</span>
                    <div>
                        <p class="font-medium text-white">GitHub ğŸ‘ Reaction (-1 point)</p>
                        <p>When your issue gets a ğŸ‘ reaction on GitHub</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-yellow-400 text-lg">â­</span>
                    <div>
                        <p class="font-medium text-white">5-Star rating (+0.5 points)</p>
                        <p>When other users rate you with 5 stars</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Footer -->
<footer class="border-t border-gray-800 bg-gray-950 py-4 px-6 mt-8">
    <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-2 text-xs text-gray-500">
        <span>Â© 2026 Xdest</span>
        <div class="flex flex-wrap justify-center gap-4">
            <a href="mailto:aiandfriends@gmail.com" class="hover:text-gray-300 transition">Contact</a>
            <a href="https://x.com/karlbeis" target="_blank" class="hover:text-gray-300 transition">ğ• @karlbeis</a>
            <a href="/privacy" class="hover:text-gray-300 transition">Privacy</a>
            <a href="/terms" class="hover:text-gray-300 transition">Terms</a>
            <a href="https://github.com/koal0308/Xdest" target="_blank" class="hover:text-gray-300 transition">GitHub</a>
        </div>
    </div>
</footer>

<script>
{% if user %}
async function loadMyStats() {
    try {
        const response = await fetch('/api/leaderboard/my-stats', {
            credentials: 'include'
        });
        if (!response.ok) {
            console.log('My stats response not ok:', response.status);
            return;
        }
        
        const data = await response.json();
        
        // Rank
        const rankEl = document.getElementById('my-rank');
        if (data.rank) {
            const rankEmoji = data.rank === 1 ? 'ğŸ¥‡' : data.rank === 2 ? 'ğŸ¥ˆ' : data.rank === 3 ? 'ğŸ¥‰' : '#';
            rankEl.innerHTML = `Rank: ${rankEmoji}${data.rank <= 3 ? '' : data.rank}`;
        } else {
            rankEl.innerHTML = 'Not ranked yet';
        }
        
        // Breakdown
        document.getElementById('stat-solutions').textContent = 
            `${data.breakdown.solutions.count} (${data.breakdown.solutions.points > 0 ? '+' : ''}${data.breakdown.solutions.points})`;
        document.getElementById('stat-response-helpful').textContent = 
            `${data.breakdown.response_helpful.count} (${data.breakdown.response_helpful.points > 0 ? '+' : ''}${data.breakdown.response_helpful.points})`;
        document.getElementById('stat-issue-helpful').textContent = 
            `${data.breakdown.issue_helpful.count} (${data.breakdown.issue_helpful.points > 0 ? '+' : ''}${data.breakdown.issue_helpful.points})`;
        
        const ghPoints = data.breakdown.github_reactions.points;
        document.getElementById('stat-github').textContent = 
            `+${data.breakdown.github_reactions.positive}/-${data.breakdown.github_reactions.negative} (${ghPoints >= 0 ? '+' : ''}${ghPoints})`;
        
        document.getElementById('stat-five-star').textContent = 
            `${data.breakdown.five_star_ratings.count} (+${data.breakdown.five_star_ratings.points})`;
        
        // Total Score
        document.getElementById('my-total-score').textContent = data.total_score;
        
        // Recent Activities
        const activitiesEl = document.getElementById('recent-activities');
        if (data.recent_activities.length === 0) {
            activitiesEl.innerHTML = `
                <div class="text-center text-gray-500 text-sm py-4">
                    <p>No point activity yet</p>
                    <p class="mt-1">Report issues, give helpful answers!</p>
                </div>
            `;
        } else {
            activitiesEl.innerHTML = data.recent_activities.map(activity => {
                const typeIcons = {
                    'solution': 'âœ…',
                    'response_helpful': 'ğŸ‘',
                    'issue_helpful': 'ğŸ“',
                    'five_star': 'â­'
                };
                const typeColors = {
                    'solution': 'text-green-400',
                    'response_helpful': 'text-blue-400',
                    'issue_helpful': 'text-yellow-400',
                    'five_star': 'text-yellow-400'
                };
                
                const date = activity.created_at ? new Date(activity.created_at).toLocaleDateString() : '';
                
                return `
                    <div class="flex items-center gap-3 bg-dark-100/30 rounded-lg p-3 text-sm">
                        <span class="text-xl">${typeIcons[activity.type] || 'ğŸ¯'}</span>
                        <div class="flex-1 min-w-0">
                            <p class="truncate">${activity.description}</p>
                            ${activity.project ? `<p class="text-xs text-gray-500">${activity.project}</p>` : ''}
                        </div>
                        <div class="text-right flex-shrink-0">
                            <span class="${typeColors[activity.type] || 'text-purple-400'} font-bold">+${activity.points}</span>
                            <p class="text-xs text-gray-500">${date}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
    } catch (error) {
        console.error('Error loading my stats:', error);
    }
}
{% endif %}

document.addEventListener('DOMContentLoaded', async function() {
    // Load personal stats if logged in
    {% if user %}
    loadMyStats();
    {% endif %}
    
    // Load leaderboard
    try {
        const response = await fetch('/api/leaderboard');
        const data = await response.json();
        
        const leaderboard = data.leaderboard;
        const podiumEl = document.getElementById('podium');
        const listEl = document.getElementById('leaderboard-list');
        
        if (leaderboard.length === 0) {
            listEl.innerHTML = `
                <div class="p-12 text-center text-gray-500">
                    <div class="text-5xl mb-4">ğŸ¤·</div>
                    <p class="text-lg">No helpful answers yet</p>
                    <p class="text-sm mt-2">Be the first to help others!</p>
                </div>
            `;
            podiumEl.innerHTML = '';
            return;
        }
        
        // Top 3 Podium
        const top3 = leaderboard.slice(0, 3);
        const podiumOrder = [1, 0, 2]; // 2nd, 1st, 3rd fÃ¼r visuelles Layout
        const podiumColors = ['from-yellow-500 to-yellow-600', 'from-gray-400 to-gray-500', 'from-orange-600 to-orange-700'];
        const podiumHeights = ['h-32', 'h-24', 'h-20'];
        const podiumLabels = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
        
        podiumEl.innerHTML = podiumOrder.map((idx, visualIdx) => {
            if (!top3[idx]) return '';
            const user = top3[idx];
            const height = podiumHeights[idx];
            const color = podiumColors[idx];
            const label = podiumLabels[idx];
            
            return `
                <a href="/user/${user.username}" class="flex flex-col items-center group">
                    <img src="${user.avatar || '/static/default-avatar.png'}" 
                         class="w-16 h-16 rounded-full border-4 border-gray-700 group-hover:border-purple-500 transition mb-2" 
                         alt="${user.username}">
                    <span class="font-semibold group-hover:text-purple-400 transition">${user.username}</span>
                    <span class="text-2xl">${label}</span>
                    <span class="text-sm text-gray-400">${user.total_score} Points</span>
                    <div class="${height} w-20 bg-gradient-to-t ${color} rounded-t-lg mt-2 flex items-center justify-center">
                        <span class="text-white font-bold text-2xl">${idx + 1}</span>
                    </div>
                </a>
            `;
        }).join('');
        
        // Full List
        listEl.innerHTML = leaderboard.map(user => `
            <a href="/user/${user.username}" 
               class="flex items-center gap-4 p-4 hover:bg-dark-200 transition border-b border-gray-800 last:border-0">
                <div class="w-8 text-center font-bold ${user.rank <= 3 ? 'text-yellow-400' : 'text-gray-500'}">
                    ${user.rank <= 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][user.rank - 1] : '#' + user.rank}
                </div>
                <img src="${user.avatar || '/static/default-avatar.png'}" 
                     class="w-10 h-10 rounded-full" alt="">
                <div class="flex-1">
                    <p class="font-semibold">${user.username}</p>
                    <p class="text-sm text-gray-500">
                        ${user.solutions_count > 0 ? `âœ… ${user.solutions_count} Solutions Â· ` : ''}${user.response_helpful > 0 ? `ğŸ‘ ${user.response_helpful} Response votes Â· ` : ''}${user.github_reactions > 0 ? `ğŸ™ ${user.github_reactions} GitHubğŸ‘ Â· ` : ''}${user.github_negative_reactions > 0 ? `ğŸ‘ ${user.github_negative_reactions} GitHubğŸ‘ Â· ` : ''}${user.issue_helpful > 0 ? `ğŸ“ ${user.issue_helpful} Issue votes` : ''}${user.five_star_ratings > 0 ? ` Â· â­ ${user.five_star_ratings}x 5â˜…` : ''}
                    </p>
                </div>
                <div class="text-right">
                    <p class="font-bold text-lg bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent">
                        ${user.total_score}
                    </p>
                    <p class="text-xs text-gray-500">Points</p>
                </div>
            </a>
        `).join('');
        
    } catch (error) {
        console.error('Error loading leaderboard:', error);
        document.getElementById('leaderboard-list').innerHTML = `
            <div class="p-8 text-center text-red-400">
                Error loading leaderboard
            </div>
        `;
    }
});
</script>
{% endblock %}
