{% extends "base.html" %}

{% block title %}Issues - {{ project.name }} - Xdest{% endblock %}

{% block content %}
<div class="min-h-screen">
    {% set active_page = 'issues' %}
    {% include 'partials/nav.html' %}

    <main class="pt-24 pb-12 px-4 max-w-5xl mx-auto">
        <!-- Breadcrumb -->
        <div class="flex items-center gap-2 text-sm text-gray-400 mb-6">
            <a href="/project/{{ project.id }}" class="hover:text-white transition">{{ project.name }}</a>
            <span>/</span>
            <span class="text-white">Issues</span>
        </div>

        <!-- Header -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold mb-1 sm:mb-2">Issues & Feedback</h1>
                <p class="text-gray-400 text-sm sm:text-base">Community feedback fÃ¼r {{ project.name }}</p>
            </div>
            <div class="flex items-center gap-2 sm:gap-3">
                {% if is_owner and project.github_url %}
                <button onclick="syncGitHubIssues()" id="syncBtn"
                        class="px-3 py-2 rounded-lg bg-dark-300 hover:bg-dark-200 transition text-xs sm:text-sm flex items-center gap-1.5 sm:gap-2 text-gray-400 hover:text-white">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/>
                    </svg>
                    <span class="hidden sm:inline">Mit GitHub synchronisieren</span>
                    <span class="sm:hidden">Sync</span>
                </button>
                {% endif %}
                {% if user %}
                <a href="/project/{{ project.id }}/issues/new" 
                   class="px-4 py-2 sm:px-6 sm:py-3 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 transition font-semibold flex items-center gap-1.5 sm:gap-2 text-sm sm:text-base">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Issue / Feedback
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Status Tabs -->
        <div class="flex flex-wrap gap-2 mb-6">
            <a href="/project/{{ project.id }}/issues" 
               class="px-4 py-2 rounded-lg text-sm font-medium transition {{ 'bg-purple-600 text-white' if not current_status else 'bg-dark-300 text-gray-400 hover:text-white' }}">
                All ({{ issue_counts.all }})
            </a>
            <a href="/project/{{ project.id }}/issues?status=open" 
               class="px-4 py-2 rounded-lg text-sm font-medium transition {{ 'bg-green-600 text-white' if current_status == 'open' else 'bg-dark-300 text-gray-400 hover:text-white' }}">
                ğŸŸ¢ Open ({{ issue_counts.open }})
            </a>
            <a href="/project/{{ project.id }}/issues?status=in_progress" 
               class="px-4 py-2 rounded-lg text-sm font-medium transition {{ 'bg-yellow-600 text-white' if current_status == 'in_progress' else 'bg-dark-300 text-gray-400 hover:text-white' }}">
                ğŸ”„ In Progress ({{ issue_counts.in_progress }})
            </a>
            <a href="/project/{{ project.id }}/issues?status=resolved" 
               class="px-4 py-2 rounded-lg text-sm font-medium transition {{ 'bg-blue-600 text-white' if current_status == 'resolved' else 'bg-dark-300 text-gray-400 hover:text-white' }}">
                âœ… Resolved ({{ issue_counts.resolved }})
            </a>
            <a href="/project/{{ project.id }}/issues?status=closed" 
               class="px-4 py-2 rounded-lg text-sm font-medium transition {{ 'bg-gray-600 text-white' if current_status == 'closed' else 'bg-dark-300 text-gray-400 hover:text-white' }}">
                â¬› Closed ({{ issue_counts.closed }})
            </a>
        </div>

        <!-- Type Filter -->
        <div class="flex flex-wrap gap-2 mb-8 pb-6 border-b border-gray-800">
            <span class="text-sm text-gray-500 py-2">Type:</span>
            <a href="/project/{{ project.id }}/issues{{ '?status=' + current_status if current_status else '' }}" 
               class="px-3 py-1.5 rounded-full text-xs font-medium transition {{ 'bg-purple-600/20 text-purple-400 border border-purple-600' if not current_type else 'bg-dark-300 text-gray-400 hover:text-white' }}">
                All
            </a>
            <a href="/project/{{ project.id }}/issues?issue_type=bug{{ '&status=' + current_status if current_status else '' }}" 
               class="px-3 py-1.5 rounded-full text-xs font-medium transition {{ 'bg-red-600/20 text-red-400 border border-red-600' if current_type == 'bug' else 'bg-dark-300 text-gray-400 hover:text-white' }}">
                ğŸ› Bug
            </a>
            <a href="/project/{{ project.id }}/issues?issue_type=feature{{ '&status=' + current_status if current_status else '' }}" 
               class="px-3 py-1.5 rounded-full text-xs font-medium transition {{ 'bg-green-600/20 text-green-400 border border-green-600' if current_type == 'feature' else 'bg-dark-300 text-gray-400 hover:text-white' }}">
                âœ¨ Feature Request
            </a>
            <a href="/project/{{ project.id }}/issues?issue_type=question{{ '&status=' + current_status if current_status else '' }}" 
               class="px-3 py-1.5 rounded-full text-xs font-medium transition {{ 'bg-blue-600/20 text-blue-400 border border-blue-600' if current_type == 'question' else 'bg-dark-300 text-gray-400 hover:text-white' }}">
                â“ Question
            </a>
            <a href="/project/{{ project.id }}/issues?issue_type=security{{ '&status=' + current_status if current_status else '' }}" 
               class="px-3 py-1.5 rounded-full text-xs font-medium transition {{ 'bg-orange-600/20 text-orange-400 border border-orange-600' if current_type == 'security' else 'bg-dark-300 text-gray-400 hover:text-white' }}">
                ğŸ”’ Security
            </a>
            <a href="/project/{{ project.id }}/issues?issue_type=docs{{ '&status=' + current_status if current_status else '' }}" 
               class="px-3 py-1.5 rounded-full text-xs font-medium transition {{ 'bg-cyan-600/20 text-cyan-400 border border-cyan-600' if current_type == 'docs' else 'bg-dark-300 text-gray-400 hover:text-white' }}">
                ğŸ“š Documentation
            </a>
            <a href="/project/{{ project.id }}/issues?issue_type=feedback{{ '&status=' + current_status if current_status else '' }}" 
               class="px-3 py-1.5 rounded-full text-xs font-medium transition {{ 'bg-purple-600/20 text-purple-400 border border-purple-600' if current_type == 'feedback' else 'bg-dark-300 text-gray-400 hover:text-white' }}">
                ğŸ’¬ Feedback
            </a>
        </div>

        <!-- Test Karma Banner -->
        {% if karma and is_owner %}
        <div class="mb-6 rounded-xl border {{ 'border-red-600/50 bg-red-900/10' if karma_blocked else 'border-gray-700 bg-dark-100' }} p-4">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <div class="text-2xl">âš–ï¸</div>
                    <div>
                        <h3 class="font-semibold text-sm {{ 'text-red-400' if karma_blocked else 'text-white' }}">
                            Test Karma: {{ karma.karma }}
                        </h3>
                        <p class="text-xs text-gray-400">
                            {{ karma.given }} Issues gegeben Â· {{ karma.received }} Issues empfangen
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    {% if karma_blocked %}
                        <span class="px-3 py-1 rounded-full bg-red-600/20 text-red-400 text-xs font-medium">
                            ğŸ”’ Issues versteckt (Karma unter {{ karma.limit }})
                        </span>
                    {% else %}
                        <span class="px-3 py-1 rounded-full bg-green-600/20 text-green-400 text-xs font-medium">
                            âœ… Issues sichtbar
                        </span>
                    {% endif %}
                </div>
            </div>
            {% if karma_blocked %}
            <div class="mt-3 p-3 rounded-lg bg-red-900/20 border border-red-800/30">
                <p class="text-sm text-red-300">
                    âš ï¸ <strong>Deine empfangenen Issues sind versteckt.</strong> Du hast mehr Issues empfangen als gegeben.
                    Teste andere Projekte und schreibe Issues, um dein Karma zu verbessern.
                </p>
                <a href="/explore" class="mt-2 inline-block px-4 py-1.5 rounded-lg bg-purple-600 hover:bg-purple-500 transition text-xs font-semibold text-white">
                    ğŸ” Projekte zum Testen finden
                </a>
            </div>
            {% elif karma.karma <= 0 %}
            <div class="mt-2">
                <div class="w-full bg-dark-300 rounded-full h-1.5">
                    <div class="h-1.5 rounded-full {{ 'bg-yellow-500' if karma.karma > -3 else 'bg-orange-500' }}" 
                         style="width: {{ ((karma.karma - karma.limit) / (0 - karma.limit) * 100) | int }}%"></div>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    Noch {{ karma.limit - karma.karma }} Issues bis zur Sperre. Teste andere Projekte!
                </p>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Issues List -->
        {% if issues %}
        <div class="space-y-3">
            {%- for issue in issues -%}
            <div onclick="window.location='/project/{{ project.id }}/issues/{{ issue.id }}'" 
               class="cursor-pointer bg-dark-100 rounded-xl border border-gray-800 hover:border-gray-700 p-5 transition overflow-hidden">
                <div class="flex items-start gap-4">
                    <!-- Status Icon -->
                    <div class="mt-1 flex-shrink-0">
                        {% if issue.status == 'open' %}
                            <span class="w-5 h-5 rounded-full bg-green-500 flex items-center justify-center text-xs">ğŸŸ¢</span>
                        {% elif issue.status == 'in_progress' %}
                            <span class="w-5 h-5 rounded-full bg-yellow-500 flex items-center justify-center text-xs">ğŸ”„</span>
                        {% elif issue.status == 'resolved' %}
                            <span class="w-5 h-5 rounded-full bg-blue-500 flex items-center justify-center text-xs">âœ…</span>
                        {% elif issue.status == 'closed' %}
                            <span class="w-5 h-5 rounded-full bg-gray-500 flex items-center justify-center text-xs">â¬›</span>
                        {% else %}
                            <span class="w-5 h-5 rounded-full bg-red-500 flex items-center justify-center text-xs">ğŸš«</span>
                        {% endif %}
                    </div>
                    
                    <div class="flex-1 min-w-0 overflow-hidden">
                        <div class="flex flex-wrap items-center gap-2 mb-2">
                            <h3 class="font-semibold text-lg break-words">{{ issue.title }}</h3>
                            
                            <!-- Type Badge -->
                            {% if issue.issue_type == 'bug' %}
                                <span class="px-2 py-0.5 bg-red-600/20 text-red-400 text-xs rounded-full">ğŸ› Bug</span>
                            {% elif issue.issue_type == 'feature' %}
                                <span class="px-2 py-0.5 bg-green-600/20 text-green-400 text-xs rounded-full">âœ¨ Feature</span>
                            {% elif issue.issue_type == 'question' %}
                                <span class="px-2 py-0.5 bg-blue-600/20 text-blue-400 text-xs rounded-full">â“ Question</span>
                            {% elif issue.issue_type == 'security' %}
                                <span class="px-2 py-0.5 bg-orange-600/20 text-orange-400 text-xs rounded-full">ğŸ”’ Security</span>
                            {% elif issue.issue_type == 'docs' %}
                                <span class="px-2 py-0.5 bg-cyan-600/20 text-cyan-400 text-xs rounded-full">ğŸ“š Docs</span>
                            {% elif issue.issue_type == 'feedback' %}
                                <span class="px-2 py-0.5 bg-purple-600/20 text-purple-400 text-xs rounded-full">ğŸ’¬ Feedback</span>
                            {% endif %}
                        </div>
                        
                        <p class="text-gray-400 text-sm mb-3 line-clamp-2 break-words">{{ issue.description[:150] }}{% if issue.description|length > 150 %}...{% endif %}</p>
                        
                        <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-xs text-gray-500">
                            <span class="flex items-center gap-1">
                                <img src="{{ issue.reporter.avatar or '/static/default-avatar.png' }}" class="w-4 h-4 rounded-full" alt="">
                                {{ issue.reporter.username }}
                            </span>
                            <span>via {{ issue.source_platform }}</span>
                            <span>{{ issue.created_at.strftime('%d. %B %Y') }}</span>
                            <span class="flex items-center gap-1">
                                ğŸ’¬ {{ issue.responses|length }} Responses
                            </span>
                            {% if issue.github_issue_url %}
                            <a href="{{ issue.github_issue_url }}" target="_blank" 
                               class="flex items-center gap-1 text-gray-400 hover:text-white transition"
                               onclick="event.stopPropagation();">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                    <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/>
                                </svg>
                                #{{ issue.github_issue_number }}
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {%- endfor -%}
        </div>
        {% else %}
        <div class="bg-dark-100 rounded-xl border border-gray-800 p-12 text-center">
            <div class="w-16 h-16 bg-dark-300 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <h3 class="text-xl font-semibold mb-2">No Issues</h3>
            <p class="text-gray-400 mb-6">No issues or feature requests have been submitted yet.</p>
            {% if user %}
            <a href="/project/{{ project.id }}/issues/new" class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 transition font-semibold">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Create First Issue
            </a>
            {% else %}
            <a href="/auth/github" class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-gray-800 hover:bg-gray-700 transition">
                Sign in to create an issue
            </a>
            {% endif %}
        </div>
        {% endif %}
    </main>
</div>

<!-- Footer -->
<footer class="border-t border-gray-800 bg-gray-950 py-4 px-6 mt-8">
    <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-2 text-xs text-gray-500">
        <span>Â© 2026 Xdest</span>
        <div class="flex flex-wrap justify-center gap-4">
            <a href="mailto:aiandfriends@gmail.com" class="hover:text-gray-300 transition">Contact</a>
            <a href="https://x.com/karlbeis" target="_blank" class="hover:text-gray-300 transition">ğ• @karlbeis</a>
            <a href="/privacy" class="hover:text-gray-300 transition">Privacy</a>
            <a href="/terms" class="hover:text-gray-300 transition">Terms</a>
            <a href="https://github.com/koal0308/Xdest" target="_blank" class="hover:text-gray-300 transition">GitHub</a>
        </div>
    </div>
</footer>

<script>
async function syncGitHubIssues() {
    const btn = document.getElementById('syncBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Synchronisiere...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/project/{{ project.id }}/sync-github-issues', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.synced > 0) {
            location.reload();
        } else {
            btn.innerHTML = 'âœ“ Synced';
            setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
        }
    } catch (error) {
        console.error('Sync error:', error);
        btn.innerHTML = 'âŒ Error';
        setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
    }
}
</script>
{% endblock %}
